# Automated RKE2 + Big Bang DSOP deployment to Azure

This repository is a fork of the ['BigBang Customer Template'](https://repo1.dso.mil/platform-one/big-bang/customers/template). 
It contains the configuration and artifacts required to deploy BigBang to Kubernetes.

This repository is amended to include scripts and configurations to **automate the deployment of RKE2 and BigBang to Azure** to the greatest extent possible.
This is generally achieved via a GitHub Actions workflow.

Currently, this automated process only supports dev environment deployments.

The original readme from the upstream repo is here [bigbang-readme.md](./bigbang-readme.md)

## How to use this repository

### Step 0: Pre-requisites

First, you will need to clone this repository into your own GitHub organization or account.

You will then need to pre-populate several GitHub repository secrets with credentials to Azure, GitHub, and Iron Bank.

#### Required GitHub Repository Secrets

The following GH repository secrets are required for this to work:

- `AZURE_CREDENTIALS` - A Service Principal with Owner role on your target subscription. This can be accomplished using the following command via bash with an authenticated azcli, and copying the output into this Secret. These credentials are used for the deployment of Azure resources and for accessing your RKE2 cluster. More info [here](https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli).

```bash
az ad sp create-for-rbac --name "<principal name>" --role owner --scopes /subscriptions/<subscription_id> --sdk-auth
```

- `GH_PAT` - GitHub Personal Access Token. See [GitHub docs](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token).
- `IRON_BANK_USER` - Iron Bank User name. Get from [Iron Bank](https://ironbank.dso.mil/) profile.
- `IRON_BANK_PAT` - Iron Bank Personal Access Token. Get from [Iron Bank](https://ironbank.dso.mil/) profile.

### Step 1: Create a new branch for your deployment

Create a branch from main to store configuration for your particular environment.
We recommend using the branch naming convention of `env/<env-name>`.

### Step 2: Optionally, update `config.json`

Edit `config.json` to meet your deployment needs.
By default, the `cluster_name` value will be automatically substituted with the `basename` of your branch name (*i.e.*, if your branch is `env/rke2/dsop`, then the cluster_name will be set to `dsop`).
This field will be used as a prefix for all of the Azure resources deployed by this process.

Commit and push your changes to `config.json` directly to your environment branch.

### Step 3: Sit back and watch it happen

Upon pushing changes to `config.json`, GitHub Actions will start the deployment process.
Click the Actions tab and watch your deployment take place.

The first two stages (`deploy-rke2` and `deploy-bigbang`) generally take 5-10 minutes depending on the size of your cluster.
The final stage (`verify-reconcilitation`) is a test step that monitors for the successful deployment of BigBang to your RKE2 cluster.
It generally takes 15 minutes or less.

## Acknowledgements

This repository leverages [@marlinspike](https://github.com/marlinspike)'s fantastic **[dsopbuilder](https://github.com/marlinspike/dsopbuilder)** image to deploy RKE2.

This repository is actually a fork of a fork. The intermediary upstream is [@cheruvu1](https://github.com/cheruvu1)'s [dsop-environment](https://github.com/cheruvu1/dsop-environment) repository which is responsible for the vast majority of the BigBang deployment automation, including the comprehensive `deploy.sh` script. For now, I am keeping this repsositry downstream for continued development of the automated solutions.

<!-- Old BC content that should be addressed or captured somewhere
----

### 3. Generate wildcard certificate for your domain

A certificate for domain in the key `hostname` in dev/configmap.yaml is needed for the Istio gateway.

#### Self signed certificate

A certificate for non-production environments can be generated by executing the following steps:
```bash
HOSTNAME=bigbang.dev
./scripts/create-root-cert.sh
./scripts/create-domain-cert.sh $HOSTNAME
ISTIO_GW_CRT=$(cat $HOSTNAME.crt | base64 -w0)
ISTIO_GW_KEY=$(cat $HOSTNAME.key | base64 -w0)
```

#### Key Vault stored certificate

If your certificate is stored already as secrets in keyvault set `ISTIO_GW_CRT` and `ISTIO_GW_KEY` to the keyvault id of those secrets in `secrets.sh`

```
export ISTIO_GW_CRT="<certificate id in keyvault>"
export ISTIO_GW_KEY="<certificate id in keyvault>"
```

If your certificate is stored already as secrets in keyvault set `USE_KEYVAULT_CERT` to `true` on `deploy-vars.sh`

```
export USE_KEYVAULT_CERT="true"
```

#### Changing certificate

If your certificate was changed change the value in `secrets.sh` and `deploy-vars.sh` them execute `update-certs.sh`

### 4. Configure For GitOps

Update the `dev/bigbang.yaml` file, and place your own branch name where it has `__CHANGE_ME__`

e.g.

```yaml
branch: env/dbowie
```

Now, save and commit your change:

```shell
git add dev/bigbang.yaml
git commit -m "chore: updated git repo"
git push
```

This step only needs to be done once

### 5. Deploy

1. Copy `secrets.sh.sample` to `secrets.sh` and edit to with your own values and secrets as follows:
- Set IRON_BANK_USER & IRON_BANK_PAT with the Username and CLI secret from your User Profile on https://registry1.dso.mil (After logging in click your username in the upper righthand corner).
- Set AZDO_USER & AZDO_PASSWORD with the credentials you generated in step 2
- Set ISTIO_GW_CRT & ISTIO_GW_KEY with the certificates from step 3.
2. Copy `deploy-vars.sh.sample` to `deploy-vars.sh` and configure as you wish

It is critical you get the values in these two files correct as they drive all the automation

If you want to deploy AKS as part of the deployment then set `DEPLOY_AKS="true"` by default it will not be deployed

Run the automated deployment script

```bash
cd scripts
./deploy.sh
```

This script will carry out the following:

1. One time creation of GPG keys and update to `.sops.yaml` if keys are found to exist, this step is skipped.
2. Creation/update of `secrets.enc.yaml` and pushed with git
3. _OPTIONAL: Deployment of AKS cluster._
4. _OPTIONAL: Connection to AKS cluster for kubectl etc_
5. Creation of namespaces: `bigbang` and `flux-system`
6. Creation of secrets: `sops-gpg`, `private-registry` & `private-git`
7. Deployment of Flux from the main bigbang repo which will be cloned and `scripts/install_flux.sh` run. This can be disabled by setting `DEPLOY_FLUX=false`.
8. Removes network policies which block Flux being scraped
9. Deploys the `dev/bigbang.yaml` to the cluster
10. Validates the status of the deployment

Run `kubectl get gitrepositories,ks,hr -A` to see the status of what was just deployed.

It will take between five and ten minutes for deployment to complete and all the pods to be running and healthy.You can carry on watching the deployments with `get pods -A` and `get helmreleases -A`.

### 6. Configure local domain to IP address mapping

In dev, when using a domain name not recorded in a DNS server, if we want to access the virtual services created by Bigbang, we can add the IP address - domain mapping to `/etc/hosts` running the following commands:

```bash
# get istio gateway ip
ip=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

# get domains
domains=$(kubectl --kubeconfig rke2.kubeconfig get virtualservices  -A -o jsonpath="{ .items[*].spec.hosts[*] }")

# add entry in /etc/hosts
echo "$ip $domains" | sudo tee -a /etc/hosts
```

## Test Bigbang deployment

Tests are written in python; in order to run the follow the steps below:

1. Create virtual environment
```
python -m venv ./venv
```

2. Activate environment
```
source ./venv/bin/activate
```

3. Install requirements
```
pip install -r requirements.txt
```

4. Run tests
```
pytest ./tests -v
```

## Troubleshooting

### GPG Forbidden in devcontainer

Remove $HOME/.gnupg:

```
rm -rf $HOME/.gnupg
```

-->
